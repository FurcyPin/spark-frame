
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://furcypin.github.io/spark-frame/reference/transformations/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>spark_frame.transformations - Spark-frame</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/custom_width.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spark_frame.transformations_impl.convert_all_maps_to_arrays.convert_all_maps_to_arrays" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Spark-frame" class="md-header__button md-logo" aria-label="Spark-frame" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Spark-frame
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              spark_frame.transformations
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/FurcyPin/spark-frame" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FurcyPin/spark-frame
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Spark-frame" class="md-nav__button md-logo" aria-label="Spark-frame" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Spark-frame
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/FurcyPin/spark-frame" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FurcyPin/spark-frame
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        What is spark-frame ?
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Use cases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Use cases" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Use cases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../use_cases/intro/" class="md-nav__link">
        Intro
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../use_cases/working_with_nested_data/" class="md-nav__link">
        Working with nested data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../use_cases/working_with_json/" class="md-nav__link">
        Working with json
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../use_cases/flatten_unflatten/" class="md-nav__link">
        Using flatten/unflatten
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../functions/" class="md-nav__link">
        spark_frame.functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../graph/" class="md-nav__link">
        spark_frame.graph
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nested/" class="md-nav__link">
        spark_frame.nested
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nested_functions/" class="md-nav__link">
        spark_frame.nested_functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../schema_utils/" class="md-nav__link">
        spark_frame.schema_utils
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          spark_frame.transformations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        spark_frame.transformations
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.convert_all_maps_to_arrays.convert_all_maps_to_arrays" class="md-nav__link">
    convert_all_maps_to_arrays()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.flatten.flatten" class="md-nav__link">
    flatten()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.harmonize_dataframes.harmonize_dataframes" class="md-nav__link">
    harmonize_dataframes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.parse_json_columns.parse_json_columns" class="md-nav__link">
    parse_json_columns()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.sort_all_arrays.sort_all_arrays" class="md-nav__link">
    sort_all_arrays()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.transform_all_field_names.transform_all_field_names" class="md-nav__link">
    transform_all_field_names()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.transform_all_fields.transform_all_fields" class="md-nav__link">
    transform_all_fields()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.unflatten.unflatten" class="md-nav__link">
    unflatten()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.union_dataframes.union_dataframes" class="md-nav__link">
    union_dataframes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.unpivot.unpivot" class="md-nav__link">
    unpivot()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.with_generic_typed_struct.with_generic_typed_struct" class="md-nav__link">
    with_generic_typed_struct()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.convert_all_maps_to_arrays.convert_all_maps_to_arrays" class="md-nav__link">
    convert_all_maps_to_arrays()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.flatten.flatten" class="md-nav__link">
    flatten()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.harmonize_dataframes.harmonize_dataframes" class="md-nav__link">
    harmonize_dataframes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.parse_json_columns.parse_json_columns" class="md-nav__link">
    parse_json_columns()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.sort_all_arrays.sort_all_arrays" class="md-nav__link">
    sort_all_arrays()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.transform_all_field_names.transform_all_field_names" class="md-nav__link">
    transform_all_field_names()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.transform_all_fields.transform_all_fields" class="md-nav__link">
    transform_all_fields()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.unflatten.unflatten" class="md-nav__link">
    unflatten()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.union_dataframes.union_dataframes" class="md-nav__link">
    union_dataframes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.unpivot.unpivot" class="md-nav__link">
    unpivot()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark_frame.transformations_impl.with_generic_typed_struct.with_generic_typed_struct" class="md-nav__link">
    with_generic_typed_struct()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/FurcyPin/spark-frame/tree/main/docs/reference/transformations.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>spark_frame.transformations</h1>

<p>Unlike those in <a href="#spark_framefunctions">spark_frame.functions</a>, the methods in this module all take at least one
<a class="autorefs autorefs-external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a> as argument and return a new transformed DataFrame.
These methods generally offer <em>higher order</em> transformation that requires to inspect the schema or event the content
of the input DataFrame(s) before generating the next transformation. Those are typically generic operations 
that <em>cannot</em> be implemented with one single SQL query.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Since Spark 3.3.0, all transformations can be inlined using 
<a class="autorefs autorefs-external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.transform.html#pyspark.sql.DataFrame.transform">DataFrame.transform</a>, like this:</p>
<p><code>python
df.transform(flatten).withColumn(
    "base_stats.Total",
    f.col("`base_stats.Attack`") + f.col("`base_stats.Defense`") + f.col("`base_stats.HP`") +
    f.col("`base_stats.Sp Attack`") + f.col("`base_stats.Sp Defense`") + f.col("`base_stats.Speed`")
).transform(unflatten).show(vertical=True, truncate=False)</code>
<em>This example is taken</em></p>
</div>
<hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.convert_all_maps_to_arrays.convert_all_maps_to_arrays" class="doc doc-heading">
<code class="highlight language-python"><span class="n">convert_all_maps_to_arrays</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Transform all columns of type <code>Map&lt;K,V&gt;</code> inside the given DataFrame into <code>ARRAY&lt;STRUCT&lt;key: K, value: V&gt;&gt;</code>.
This transformation works recursively on every nesting level.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This method is compatible with any schema. It recursively applies on structs, arrays and maps
and is compatible with field names containing special characters.</p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A new DataFrame in which all maps have been replaced with arrays of entries.</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT 1 as id, ARRAY(MAP(1, STRUCT(MAP(1, &quot;a&quot;) as m2))) as m1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = false)</span>
<span class="go"> |-- m1: array (nullable = false)</span>
<span class="go"> |    |-- element: map (containsNull = false)</span>
<span class="go"> |    |    |-- key: integer</span>
<span class="go"> |    |    |-- value: struct (valueContainsNull = false)</span>
<span class="go"> |    |    |    |-- m2: map (nullable = false)</span>
<span class="go"> |    |    |    |    |-- key: integer</span>
<span class="go"> |    |    |    |    |-- value: string (valueContainsNull = false)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+-------------------+</span>
<span class="go">| id|                 m1|</span>
<span class="go">+---+-------------------+</span>
<span class="go">|  1|[{1 -&gt; {{1 -&gt; a}}}]|</span>
<span class="go">+---+-------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res_df</span> <span class="o">=</span> <span class="n">convert_all_maps_to_arrays</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = false)</span>
<span class="go"> |-- m1: array (nullable = false)</span>
<span class="go"> |    |-- element: array (containsNull = false)</span>
<span class="go"> |    |    |-- element: struct (containsNull = false)</span>
<span class="go"> |    |    |    |-- key: integer (nullable = false)</span>
<span class="go"> |    |    |    |-- value: struct (nullable = false)</span>
<span class="go"> |    |    |    |    |-- m2: array (nullable = false)</span>
<span class="go"> |    |    |    |    |    |-- element: struct (containsNull = false)</span>
<span class="go"> |    |    |    |    |    |    |-- key: integer (nullable = false)</span>
<span class="go"> |    |    |    |    |    |    |-- value: string (nullable = false)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+-------------------+</span>
<span class="go">| id|                 m1|</span>
<span class="go">+---+-------------------+</span>
<span class="go">|  1|[[{1, {[{1, a}]}}]]|</span>
<span class="go">+---+-------------------+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/convert_all_maps_to_arrays.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">convert_all_maps_to_arrays</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Transform all columns of type `Map&lt;K,V&gt;` inside the given DataFrame into `ARRAY&lt;STRUCT&lt;key: K, value: V&gt;&gt;`.</span>
<span class="sd">    This transformation works recursively on every nesting level.</span>

<span class="sd">    !!! info</span>
<span class="sd">        This method is compatible with any schema. It recursively applies on structs, arrays and maps</span>
<span class="sd">        and is compatible with field names containing special characters.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A Spark DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame in which all maps have been replaced with arrays of entries.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;SELECT 1 as id, ARRAY(MAP(1, STRUCT(MAP(1, &quot;a&quot;) as m2))) as m1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = false)</span>
<span class="sd">         |-- m1: array (nullable = false)</span>
<span class="sd">         |    |-- element: map (containsNull = false)</span>
<span class="sd">         |    |    |-- key: integer</span>
<span class="sd">         |    |    |-- value: struct (valueContainsNull = false)</span>
<span class="sd">         |    |    |    |-- m2: map (nullable = false)</span>
<span class="sd">         |    |    |    |    |-- key: integer</span>
<span class="sd">         |    |    |    |    |-- value: string (valueContainsNull = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df.show()</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        | id|                 m1|</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        |  1|[{1 -&gt; {{1 -&gt; a}}}]|</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; res_df = convert_all_maps_to_arrays(df)</span>
<span class="sd">        &gt;&gt;&gt; res_df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = false)</span>
<span class="sd">         |-- m1: array (nullable = false)</span>
<span class="sd">         |    |-- element: array (containsNull = false)</span>
<span class="sd">         |    |    |-- element: struct (containsNull = false)</span>
<span class="sd">         |    |    |    |-- key: integer (nullable = false)</span>
<span class="sd">         |    |    |    |-- value: struct (nullable = false)</span>
<span class="sd">         |    |    |    |    |-- m2: array (nullable = false)</span>
<span class="sd">         |    |    |    |    |    |-- element: struct (containsNull = false)</span>
<span class="sd">         |    |    |    |    |    |    |-- key: integer (nullable = false)</span>
<span class="sd">         |    |    |    |    |    |    |-- value: string (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; res_df.show()</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        | id|                 m1|</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        |  1|[[{1, {[{1, a}]}}]]|</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">map_to_arrays</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="n">Column</span><span class="p">,</span> <span class="n">data_type</span><span class="p">:</span> <span class="n">DataType</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">map_entries</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transform_all_fields</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">map_to_arrays</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.flatten.flatten" class="doc doc-heading">
<code class="highlight language-python"><span class="n">flatten</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">struct_separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Flatten all the struct columns of a Spark <a class="autorefs autorefs-external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a>.
Nested fields names will be joined together using the specified separator</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>struct_separator</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>A string used to separate the structs names from their elements.
It might be useful to change the separator when some DataFrame's column names already contain dots</p></td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A flattened DataFrame</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span>
<span class="gp">... </span>        <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})],</span>
<span class="gp">... </span>        <span class="s2">&quot;id INT, s STRUCT&lt;a:INT, b:STRUCT&lt;c:INT, d:INT&gt;&gt;&quot;</span>
<span class="gp">... </span>     <span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s: struct (nullable = true)</span>
<span class="go"> |    |-- a: integer (nullable = true)</span>
<span class="go"> |    |-- b: struct (nullable = true)</span>
<span class="go"> |    |    |-- c: integer (nullable = true)</span>
<span class="go"> |    |    |-- d: integer (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">flatten</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s.a: integer (nullable = true)</span>
<span class="go"> |-- s.b.c: integer (nullable = true)</span>
<span class="go"> |-- s.b.d: integer (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span>
<span class="gp">... </span>        <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;a.a1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b.b1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c.c1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;d.d1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})],</span>
<span class="gp">... </span>        <span class="s2">&quot;id INT, `s.s1` STRUCT&lt;`a.a1`:INT, `b.b1`:STRUCT&lt;`c.c1`:INT, `d.d1`:INT&gt;&gt;&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s.s1: struct (nullable = true)</span>
<span class="go"> |    |-- a.a1: integer (nullable = true)</span>
<span class="go"> |    |-- b.b1: struct (nullable = true)</span>
<span class="go"> |    |    |-- c.c1: integer (nullable = true)</span>
<span class="go"> |    |    |-- d.d1: integer (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">flatten</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s.s1?a.a1: integer (nullable = true)</span>
<span class="go"> |-- s.s1?b.b1?c.c1: integer (nullable = true)</span>
<span class="go"> |-- s.s1?b.b1?d.d1: integer (nullable = true)</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/flatten.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">struct_separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Flatten all the struct columns of a Spark [DataFrame][pyspark.sql.DataFrame].</span>
<span class="sd">    Nested fields names will be joined together using the specified separator</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A Spark DataFrame</span>
<span class="sd">        struct_separator: A string used to separate the structs names from their elements.</span>
<span class="sd">            It might be useful to change the separator when some DataFrame&#39;s column names already contain dots</span>

<span class="sd">    Returns:</span>
<span class="sd">        A flattened DataFrame</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame(</span>
<span class="sd">        ...         [(1, {&quot;a&quot;: 1, &quot;b&quot;: {&quot;c&quot;: 1, &quot;d&quot;: 1}})],</span>
<span class="sd">        ...         &quot;id INT, s STRUCT&lt;a:INT, b:STRUCT&lt;c:INT, d:INT&gt;&gt;&quot;</span>
<span class="sd">        ...      )</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s: struct (nullable = true)</span>
<span class="sd">         |    |-- a: integer (nullable = true)</span>
<span class="sd">         |    |-- b: struct (nullable = true)</span>
<span class="sd">         |    |    |-- c: integer (nullable = true)</span>
<span class="sd">         |    |    |-- d: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; flatten(df).printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s.a: integer (nullable = true)</span>
<span class="sd">         |-- s.b.c: integer (nullable = true)</span>
<span class="sd">         |-- s.b.d: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame(</span>
<span class="sd">        ...         [(1, {&quot;a.a1&quot;: 1, &quot;b.b1&quot;: {&quot;c.c1&quot;: 1, &quot;d.d1&quot;: 1}})],</span>
<span class="sd">        ...         &quot;id INT, `s.s1` STRUCT&lt;`a.a1`:INT, `b.b1`:STRUCT&lt;`c.c1`:INT, `d.d1`:INT&gt;&gt;&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s.s1: struct (nullable = true)</span>
<span class="sd">         |    |-- a.a1: integer (nullable = true)</span>
<span class="sd">         |    |-- b.b1: struct (nullable = true)</span>
<span class="sd">         |    |    |-- c.c1: integer (nullable = true)</span>
<span class="sd">         |    |    |-- d.d1: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; flatten(df, &quot;?&quot;).printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s.s1?a.a1: integer (nullable = true)</span>
<span class="sd">         |-- s.s1?b.b1?c.c1: integer (nullable = true)</span>
<span class="sd">         |-- s.s1?b.b1?d.d1: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The idea is to recursively write a &quot;SELECT s.b.c as `s.b.c`&quot; for each nested column.</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">expand_struct</span><span class="p">(</span><span class="n">struct</span><span class="p">:</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">col_stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">struct</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span> <span class="o">==</span> <span class="n">StructType</span><span class="p">:</span>
                <span class="n">struct_field</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">StructType</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span>
                <span class="n">expand_struct</span><span class="p">(</span><span class="n">struct_field</span><span class="p">,</span> <span class="n">col_stack</span> <span class="o">+</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_columns</span><span class="p">(</span><span class="n">col_stack</span> <span class="o">+</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">struct_separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col_stack</span> <span class="o">+</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])))</span>

    <span class="n">expand_struct</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">col_stack</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.harmonize_dataframes.harmonize_dataframes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">harmonize_dataframes</span><span class="p">(</span><span class="n">left_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">right_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">common_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">]</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Given two DataFrames, returns two new corresponding DataFrames with the same schemas by applying the following
changes:</p>
<ul>
<li>Only common columns are kept</li>
<li>Columns of type MAP<key, value> are cast into ARRAY<STRUCT\<key, value>></li>
<li>Columns are re-order to have the same ordering in both DataFrames</li>
<li>When matching columns have different types, their type is widened to their most narrow common type.
This transformation is applied recursively on nested columns, including those inside
repeated records (a.k.a. ARRAY&lt;STRUCT&lt;&gt;&gt;).</li>
</ul>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>left_df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>right_df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>common_columns</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[<span title="typing.Tuple">Tuple</span>[str, <span title="typing.Optional">Optional</span>[str]]]]</code>
          </td>
          <td><p>A list of (column name, type) tuples.
Column names must appear in both DataFrames, and each column will be cast into the corresponding type.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a>, <a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a>]</code>
          </td>
          <td><p>Two new Spark DataFrames with the same schema</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT 1 as id, STRUCT(2 as a, ARRAY(STRUCT(3 as b, 4 as c)) as s2) as s1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df2</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT 1 as id, STRUCT(2 as a, ARRAY(STRUCT(3.0 as b, &quot;4&quot; as c, 5 as d)) as s2) as s1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">pyspark.sql.utils.AnalysisException</span>: <span class="n">Union can only be performed on tables with the compatible column types. ...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">harmonize_dataframes</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+---------------+</span>
<span class="go">| id|             s1|</span>
<span class="go">+---+---------------+</span>
<span class="go">|  1|{2, [{3.0, 4}]}|</span>
<span class="go">|  1|{2, [{3.0, 4}]}|</span>
<span class="go">+---+---------------+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/harmonize_dataframes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">harmonize_dataframes</span><span class="p">(</span>
    <span class="n">left_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">right_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">common_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Given two DataFrames, returns two new corresponding DataFrames with the same schemas by applying the following</span>
<span class="sd">    changes:</span>

<span class="sd">    - Only common columns are kept</span>
<span class="sd">    - Columns of type MAP&lt;key, value&gt; are cast into ARRAY&lt;STRUCT&lt;key, value&gt;&gt;</span>
<span class="sd">    - Columns are re-order to have the same ordering in both DataFrames</span>
<span class="sd">    - When matching columns have different types, their type is widened to their most narrow common type.</span>
<span class="sd">    This transformation is applied recursively on nested columns, including those inside</span>
<span class="sd">    repeated records (a.k.a. ARRAY&lt;STRUCT&lt;&gt;&gt;).</span>

<span class="sd">    Args:</span>
<span class="sd">        left_df: A Spark DataFrame</span>
<span class="sd">        right_df: A Spark DataFrame</span>
<span class="sd">        common_columns: A list of (column name, type) tuples.</span>
<span class="sd">            Column names must appear in both DataFrames, and each column will be cast into the corresponding type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Two new Spark DataFrames with the same schema</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df1 = spark.sql(&#39;SELECT 1 as id, STRUCT(2 as a, ARRAY(STRUCT(3 as b, 4 as c)) as s2) as s1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df2 = spark.sql(&#39;SELECT 1 as id, STRUCT(2 as a, ARRAY(STRUCT(3.0 as b, &quot;4&quot; as c, 5 as d)) as s2) as s1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df1.union(df2).show(truncate=False) # doctest: +ELLIPSIS</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        pyspark.sql.utils.AnalysisException: Union can only be performed on tables with the compatible column types. ...</span>
<span class="sd">        &gt;&gt;&gt; df1, df2 = harmonize_dataframes(df1, df2)</span>
<span class="sd">        &gt;&gt;&gt; df1.union(df2).show()</span>
<span class="sd">        +---+---------------+</span>
<span class="sd">        | id|             s1|</span>
<span class="sd">        +---+---------------+</span>
<span class="sd">        |  1|{2, [{3.0, 4}]}|</span>
<span class="sd">        |  1|{2, [{3.0, 4}]}|</span>
<span class="sd">        +---+---------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">common_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left_schema_flat</span> <span class="o">=</span> <span class="n">flatten_schema</span><span class="p">(</span><span class="n">left_df</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">right_schema_flat</span> <span class="o">=</span> <span class="n">flatten_schema</span><span class="p">(</span><span class="n">right_df</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">common_columns</span> <span class="o">=</span> <span class="n">get_common_columns</span><span class="p">(</span><span class="n">left_schema_flat</span><span class="p">,</span> <span class="n">right_schema_flat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_col</span><span class="p">(</span><span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">col_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">PrintableFunction</span><span class="p">:</span>
        <span class="n">parent_structs</span> <span class="o">=</span> <span class="n">_deepest_granularity</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tpe</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col_type</span><span class="p">)</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">PrintableFunction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tpe</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">.cast(</span><span class="si">{</span><span class="n">tpe</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">higher_order</span><span class="o">.</span><span class="n">identity</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">higher_order</span><span class="o">.</span><span class="n">recursive_struct_get</span><span class="p">(</span><span class="n">parent_structs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fp</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>

    <span class="n">common_columns_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col_name</span><span class="p">:</span> <span class="n">build_col</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">common_columns</span><span class="p">}</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">_build_nested_struct_tree</span><span class="p">(</span><span class="n">common_columns_dict</span><span class="p">)</span>
    <span class="n">root_transformation</span> <span class="o">=</span> <span class="n">_build_transformation_from_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">left_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">root_transformation</span><span class="p">(</span><span class="n">left_df</span><span class="p">)),</span> <span class="n">right_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">root_transformation</span><span class="p">(</span><span class="n">right_df</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.parse_json_columns.parse_json_columns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_json_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Transform the specified columns containing json strings in the given DataFrame into structs containing
the equivalent parsed information.</p>
<p>This method is similar to Spark's <code>from_json</code> function, with one main difference: <code>from_json</code> requires the user
to pass the expected json schema, while this method performs a first pass on the DataFrame to detect automatically
the json schema of each column.</p>
<p>By default, the output columns will have the same name as the input columns, but if you want to keep the input
columns you can pass a dict(input_col_name, output_col_name) to specify different output column names.</p>
<p>Please be aware that automatic schema detection is not very robust, and while this method can be quite helpful
for quick prototyping and data exploration, it is recommended to use a fixed schema and make sure the schema
of the input json data is properly enforce, or at the very least use schema have a drift detection mechanism.</p>
<p>WARNING : when you use this method on a column that is inside a struct (e.g. column "a.b.c"),
instead of replacing that column it will create a new column outside the struct (e.g. "<code>a.b.c</code>") (See Example 2).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>columns</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, <span title="typing.List">List</span>[str], <span title="typing.Dict">Dict</span>[str, str]]</code>
          </td>
          <td><p>A column name, list of column names, or dict(column_name, parsed_column_name)</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A new DataFrame</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <p><strong>Example 1 :</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>
<span class="gp">... </span>        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]&#39;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]&#39;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">],</span> <span class="s2">&quot;id INT, json1 STRING&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+--------------------+</span>
<span class="go">| id|               json1|</span>
<span class="go">+---+--------------------+</span>
<span class="go">|  1|[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]|</span>
<span class="go">|  1|[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]|</span>
<span class="go">|  2|                null|</span>
<span class="go">+---+--------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- json1: string (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">parse_json_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;json1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- json1: array (nullable = true)</span>
<span class="go"> |    |-- element: struct (containsNull = true)</span>
<span class="go"> |    |    |-- a: long (nullable = true)</span>
</code></pre></div>
    <p><strong>Example 2 : different output column name :</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">parse_json_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;json1&#39;</span><span class="p">:</span> <span class="s1">&#39;parsed_json1&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- json1: string (nullable = true)</span>
<span class="go"> |-- parsed_json1: array (nullable = true)</span>
<span class="go"> |    |-- element: struct (containsNull = true)</span>
<span class="go"> |    |    |-- a: long (nullable = true)</span>
</code></pre></div>
    <p><strong>Example 3 : json inside a struct :</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>
<span class="gp">... </span>        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;json1&#39;</span><span class="p">:</span> <span class="s1">&#39;[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]&#39;</span><span class="p">}),</span>
<span class="gp">... </span>        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;json1&#39;</span><span class="p">:</span> <span class="s1">&#39;[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]&#39;</span><span class="p">}),</span>
<span class="gp">... </span>        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">],</span> <span class="s2">&quot;id INT, struct STRUCT&lt;json1: STRING&gt;&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="go">+---+----------------------+</span>
<span class="go">|id |struct                |</span>
<span class="go">+---+----------------------+</span>
<span class="go">|1  |{[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]}|</span>
<span class="go">|1  |{[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]}|</span>
<span class="go">|2  |null                  |</span>
<span class="go">+---+----------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- struct: struct (nullable = true)</span>
<span class="go"> |    |-- json1: string (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">parse_json_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;struct.json1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- struct: struct (nullable = true)</span>
<span class="go"> |    |-- json1: string (nullable = true)</span>
<span class="go"> |-- struct.json1: array (nullable = true)</span>
<span class="go"> |    |-- element: struct (containsNull = true)</span>
<span class="go"> |    |    |-- a: long (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="go">+---+----------------------+------------+</span>
<span class="go">|id |struct                |struct.json1|</span>
<span class="go">+---+----------------------+------------+</span>
<span class="go">|1  |{[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]}|[{1}, {2}]  |</span>
<span class="go">|1  |{[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]}|[{2}, {4}]  |</span>
<span class="go">|2  |null                  |null        |</span>
<span class="go">+---+----------------------+------------+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/parse_json_columns.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_json_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Transform the specified columns containing json strings in the given DataFrame into structs containing</span>
<span class="sd">    the equivalent parsed information.</span>

<span class="sd">    This method is similar to Spark&#39;s `from_json` function, with one main difference: `from_json` requires the user</span>
<span class="sd">    to pass the expected json schema, while this method performs a first pass on the DataFrame to detect automatically</span>
<span class="sd">    the json schema of each column.</span>

<span class="sd">    By default, the output columns will have the same name as the input columns, but if you want to keep the input</span>
<span class="sd">    columns you can pass a dict(input_col_name, output_col_name) to specify different output column names.</span>

<span class="sd">    Please be aware that automatic schema detection is not very robust, and while this method can be quite helpful</span>
<span class="sd">    for quick prototyping and data exploration, it is recommended to use a fixed schema and make sure the schema</span>
<span class="sd">    of the input json data is properly enforce, or at the very least use schema have a drift detection mechanism.</span>

<span class="sd">    WARNING : when you use this method on a column that is inside a struct (e.g. column &quot;a.b.c&quot;),</span>
<span class="sd">    instead of replacing that column it will create a new column outside the struct (e.g. &quot;`a.b.c`&quot;) (See Example 2).</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A Spark DataFrame</span>
<span class="sd">        columns: A column name, list of column names, or dict(column_name, parsed_column_name)</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame</span>

<span class="sd">    Examples:</span>
<span class="sd">        **Example 1 :**</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame([</span>
<span class="sd">        ...         (1, &#39;[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]&#39;),</span>
<span class="sd">        ...         (1, &#39;[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]&#39;),</span>
<span class="sd">        ...         (2, None)</span>
<span class="sd">        ...     ], &quot;id INT, json1 STRING&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; df.show()</span>
<span class="sd">        +---+--------------------+</span>
<span class="sd">        | id|               json1|</span>
<span class="sd">        +---+--------------------+</span>
<span class="sd">        |  1|[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]|</span>
<span class="sd">        |  1|[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]|</span>
<span class="sd">        |  2|                null|</span>
<span class="sd">        +---+--------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- json1: string (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; parse_json_columns(df, &#39;json1&#39;).printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- json1: array (nullable = true)</span>
<span class="sd">         |    |-- element: struct (containsNull = true)</span>
<span class="sd">         |    |    |-- a: long (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        **Example 2 : different output column name :**</span>
<span class="sd">        &gt;&gt;&gt; parse_json_columns(df, {&#39;json1&#39;: &#39;parsed_json1&#39;}).printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- json1: string (nullable = true)</span>
<span class="sd">         |-- parsed_json1: array (nullable = true)</span>
<span class="sd">         |    |-- element: struct (containsNull = true)</span>
<span class="sd">         |    |    |-- a: long (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        **Example 3 : json inside a struct :**</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame([</span>
<span class="sd">        ...         (1, {&#39;json1&#39;: &#39;[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]&#39;}),</span>
<span class="sd">        ...         (1, {&#39;json1&#39;: &#39;[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]&#39;}),</span>
<span class="sd">        ...         (2, None)</span>
<span class="sd">        ...     ], &quot;id INT, struct STRUCT&lt;json1: STRING&gt;&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; df.show(10, False)</span>
<span class="sd">        +---+----------------------+</span>
<span class="sd">        |id |struct                |</span>
<span class="sd">        +---+----------------------+</span>
<span class="sd">        |1  |{[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]}|</span>
<span class="sd">        |1  |{[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]}|</span>
<span class="sd">        |2  |null                  |</span>
<span class="sd">        +---+----------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- struct: struct (nullable = true)</span>
<span class="sd">         |    |-- json1: string (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; res = parse_json_columns(df, &#39;struct.json1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; res.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- struct: struct (nullable = true)</span>
<span class="sd">         |    |-- json1: string (nullable = true)</span>
<span class="sd">         |-- struct.json1: array (nullable = true)</span>
<span class="sd">         |    |-- element: struct (containsNull = true)</span>
<span class="sd">         |    |    |-- a: long (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; res.show(10, False)</span>
<span class="sd">        +---+----------------------+------------+</span>
<span class="sd">        |id |struct                |struct.json1|</span>
<span class="sd">        +---+----------------------+------------+</span>
<span class="sd">        |1  |{[{&quot;a&quot;: 1}, {&quot;a&quot;: 2}]}|[{1}, {2}]  |</span>
<span class="sd">        |1  |{[{&quot;a&quot;: 2}, {&quot;a&quot;: 4}]}|[{2}, {4}]  |</span>
<span class="sd">        |2  |null                  |null        |</span>
<span class="sd">        +---+----------------------+------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>

    <span class="n">wrapped_df</span> <span class="o">=</span> <span class="n">__wrap_json_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
    <span class="n">schema_per_col</span> <span class="o">=</span> <span class="n">__infer_schema_per_column</span><span class="p">(</span><span class="n">wrapped_df</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">__parse_json_columns</span><span class="p">(</span><span class="n">wrapped_df</span><span class="p">,</span> <span class="n">schema_per_col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.sort_all_arrays.sort_all_arrays" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sort_all_arrays</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Given a DataFrame, sort all fields of type <code>ARRAY</code> in a canonical order, making them comparable.
This also applies to nested fields, even those inside other arrays.</p>
<div class="admonition warning">
<p class="admonition-title">Limitation</p>
<ul>
<li>Arrays containing sub-fields of type Map cannot be sorted, as the Map type is not comparable.</li>
<li>A possible workaround is to first use the transformation
<a class="autorefs autorefs-internal" href="#spark_frame.transformations_impl.convert_all_maps_to_arrays.convert_all_maps_to_arrays"><code>spark_frame.transformations.convert_all_maps_to_arrays</code></a></li>
</ul>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A new DataFrame where all arrays have been sorted.</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <p><em>Example 1:</em> with a simple <code>ARRAY&lt;INT&gt;</code></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT 1 as id, ARRAY(3, 2, 1) as a&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+---------+</span>
<span class="go">| id|        a|</span>
<span class="go">+---+---------+</span>
<span class="go">|  1|[3, 2, 1]|</span>
<span class="go">+---+---------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">sort_all_arrays</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+---------+</span>
<span class="go">| id|        a|</span>
<span class="go">+---+---------+</span>
<span class="go">|  1|[1, 2, 3]|</span>
<span class="go">+---+---------+</span>
</code></pre></div>
    <p><em>Example 2:</em> with an <code>ARRAY&lt;STRUCT&lt;...&gt;&gt;</code></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT ARRAY(STRUCT(2 as a, 1 as b), STRUCT(1 as a, 2 as b), STRUCT(1 as a, 1 as b)) as s&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+------------------------+</span>
<span class="go">|s                       |</span>
<span class="go">+------------------------+</span>
<span class="go">|[{2, 1}, {1, 2}, {1, 1}]|</span>
<span class="go">+------------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sort_all_arrays</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+------------------------+</span>
<span class="go">|s                       |</span>
<span class="go">+------------------------+</span>
<span class="go">|[{1, 1}, {1, 2}, {2, 1}]|</span>
<span class="go">+------------------------+</span>
</code></pre></div>
    <p><em>Example 3:</em> with an <code>ARRAY&lt;STRUCT&lt;STRUCT&lt;...&gt;&gt;&gt;</code></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT ARRAY(</span>
<span class="gp">... </span><span class="s1">        STRUCT(STRUCT(2 as a, 2 as b) as s),</span>
<span class="gp">... </span><span class="s1">        STRUCT(STRUCT(1 as a, 2 as b) as s)</span>
<span class="gp">... </span><span class="s1">    ) as l1</span>
<span class="gp">... </span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+--------------------+</span>
<span class="go">|l1                  |</span>
<span class="go">+--------------------+</span>
<span class="go">|[{{2, 2}}, {{1, 2}}]|</span>
<span class="go">+--------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sort_all_arrays</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+--------------------+</span>
<span class="go">|l1                  |</span>
<span class="go">+--------------------+</span>
<span class="go">|[{{1, 2}}, {{2, 2}}]|</span>
<span class="go">+--------------------+</span>
</code></pre></div>
    <p><em>Example 4:</em> with an <code>ARRAY&lt;ARRAY&lt;ARRAY&lt;INT&gt;&gt;&gt;</code></p>
<p>As this example shows, the innermost arrays are sorted before the outermost arrays.</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT ARRAY(</span>
<span class="gp">... </span><span class="s1">        ARRAY(ARRAY(4, 1), ARRAY(3, 2)),</span>
<span class="gp">... </span><span class="s1">        ARRAY(ARRAY(2, 2), ARRAY(2, 1))</span>
<span class="gp">... </span><span class="s1">    ) as l1</span>
<span class="gp">... </span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+------------------------------------+</span>
<span class="go">|l1                                  |</span>
<span class="go">+------------------------------------+</span>
<span class="go">|[[[4, 1], [3, 2]], [[2, 2], [2, 1]]]|</span>
<span class="go">+------------------------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sort_all_arrays</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+------------------------------------+</span>
<span class="go">|l1                                  |</span>
<span class="go">+------------------------------------+</span>
<span class="go">|[[[1, 2], [2, 2]], [[1, 4], [2, 3]]]|</span>
<span class="go">+------------------------------------+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/sort_all_arrays.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sort_all_arrays</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Given a DataFrame, sort all fields of type `ARRAY` in a canonical order, making them comparable.</span>
<span class="sd">    This also applies to nested fields, even those inside other arrays.</span>

<span class="sd">    !!! warning &quot;Limitation&quot;</span>
<span class="sd">        - Arrays containing sub-fields of type Map cannot be sorted, as the Map type is not comparable.</span>
<span class="sd">        - A possible workaround is to first use the transformation</span>
<span class="sd">        [`spark_frame.transformations.convert_all_maps_to_arrays`]</span>
<span class="sd">        [spark_frame.transformations_impl.convert_all_maps_to_arrays.convert_all_maps_to_arrays]</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A Spark DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame where all arrays have been sorted.</span>

<span class="sd">    Examples:</span>
<span class="sd">        *Example 1:* with a simple `ARRAY&lt;INT&gt;`</span>

<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;SELECT 1 as id, ARRAY(3, 2, 1) as a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.show()</span>
<span class="sd">        +---+---------+</span>
<span class="sd">        | id|        a|</span>
<span class="sd">        +---+---------+</span>
<span class="sd">        |  1|[3, 2, 1]|</span>
<span class="sd">        +---+---------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; sort_all_arrays(df).show()</span>
<span class="sd">        +---+---------+</span>
<span class="sd">        | id|        a|</span>
<span class="sd">        +---+---------+</span>
<span class="sd">        |  1|[1, 2, 3]|</span>
<span class="sd">        +---+---------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        *Example 2:* with an `ARRAY&lt;STRUCT&lt;...&gt;&gt;`</span>

<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;SELECT ARRAY(STRUCT(2 as a, 1 as b), STRUCT(1 as a, 2 as b), STRUCT(1 as a, 1 as b)) as s&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.show(truncate=False)</span>
<span class="sd">        +------------------------+</span>
<span class="sd">        |s                       |</span>
<span class="sd">        +------------------------+</span>
<span class="sd">        |[{2, 1}, {1, 2}, {1, 1}]|</span>
<span class="sd">        +------------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df.transform(sort_all_arrays).show(truncate=False)</span>
<span class="sd">        +------------------------+</span>
<span class="sd">        |s                       |</span>
<span class="sd">        +------------------------+</span>
<span class="sd">        |[{1, 1}, {1, 2}, {2, 1}]|</span>
<span class="sd">        +------------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        *Example 3:* with an `ARRAY&lt;STRUCT&lt;STRUCT&lt;...&gt;&gt;&gt;`</span>

<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;&#39;&#39;SELECT ARRAY(</span>
<span class="sd">        ...         STRUCT(STRUCT(2 as a, 2 as b) as s),</span>
<span class="sd">        ...         STRUCT(STRUCT(1 as a, 2 as b) as s)</span>
<span class="sd">        ...     ) as l1</span>
<span class="sd">        ... &#39;&#39;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.show(truncate=False)</span>
<span class="sd">        +--------------------+</span>
<span class="sd">        |l1                  |</span>
<span class="sd">        +--------------------+</span>
<span class="sd">        |[{{2, 2}}, {{1, 2}}]|</span>
<span class="sd">        +--------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df.transform(sort_all_arrays).show(truncate=False)</span>
<span class="sd">        +--------------------+</span>
<span class="sd">        |l1                  |</span>
<span class="sd">        +--------------------+</span>
<span class="sd">        |[{{1, 2}}, {{2, 2}}]|</span>
<span class="sd">        +--------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        *Example 4:* with an `ARRAY&lt;ARRAY&lt;ARRAY&lt;INT&gt;&gt;&gt;`</span>

<span class="sd">        As this example shows, the innermost arrays are sorted before the outermost arrays.</span>

<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;&#39;&#39;SELECT ARRAY(</span>
<span class="sd">        ...         ARRAY(ARRAY(4, 1), ARRAY(3, 2)),</span>
<span class="sd">        ...         ARRAY(ARRAY(2, 2), ARRAY(2, 1))</span>
<span class="sd">        ...     ) as l1</span>
<span class="sd">        ... &#39;&#39;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.show(truncate=False)</span>
<span class="sd">        +------------------------------------+</span>
<span class="sd">        |l1                                  |</span>
<span class="sd">        +------------------------------------+</span>
<span class="sd">        |[[[4, 1], [3, 2]], [[2, 2], [2, 1]]]|</span>
<span class="sd">        +------------------------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df.transform(sort_all_arrays).show(truncate=False)</span>
<span class="sd">        +------------------------------------+</span>
<span class="sd">        |l1                                  |</span>
<span class="sd">        +------------------------------------+</span>
<span class="sd">        |[[[1, 2], [2, 2]], [[1, 4], [2, 3]]]|</span>
<span class="sd">        +------------------------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">sort_array</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="n">Column</span><span class="p">,</span> <span class="n">data_type</span><span class="p">:</span> <span class="n">DataType</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">sort_array</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transform_all_fields</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sort_array</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.transform_all_field_names.transform_all_field_names" class="doc doc-heading">
<code class="highlight language-python"><span class="n">transform_all_field_names</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">transformation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Apply a transformation to all nested field names of a DataFrame.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This method is compatible with any schema. It recursively applies on structs, arrays and maps
and is compatible with field names containing special characters.</p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>transformation</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span>[[str], str]</code>
          </td>
          <td><p>Transformation to apply to all field names in the DataFrame.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A new DataFrame</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <p><em><strong>Example 1: with a nested schema structure</strong></em></p>
<p>In this example we cast all the field names of the schema to uppercase:</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">spark_frame</span> <span class="kn">import</span> <span class="n">nested</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT</span>
<span class="gp">... </span><span class="s1">    &quot;John&quot; as name,</span>
<span class="gp">... </span><span class="s1">    ARRAY(STRUCT(1 as a), STRUCT(2 as a)) as s1,</span>
<span class="gp">... </span><span class="s1">    ARRAY(ARRAY(1, 2), ARRAY(3, 4)) as s2,</span>
<span class="gp">... </span><span class="s1">    ARRAY(ARRAY(STRUCT(1 as a)), ARRAY(STRUCT(2 as a))) as s3,</span>
<span class="gp">... </span><span class="s1">    ARRAY(STRUCT(ARRAY(1, 2) as a), STRUCT(ARRAY(3, 4) as a)) as s4,</span>
<span class="gp">... </span><span class="s1">    ARRAY(</span>
<span class="gp">... </span><span class="s1">        STRUCT(ARRAY(STRUCT(STRUCT(1 as c) as b), STRUCT(STRUCT(2 as c) as b)) as a),</span>
<span class="gp">... </span><span class="s1">        STRUCT(ARRAY(STRUCT(STRUCT(3 as c) as b), STRUCT(STRUCT(4 as c) as b)) as a)</span>
<span class="gp">... </span><span class="s1">    ) as s5</span>
<span class="gp">... </span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nested</span><span class="o">.</span><span class="n">print_schema</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="go">root</span>
<span class="go"> |-- name: string (nullable = false)</span>
<span class="go"> |-- s1!.a: integer (nullable = false)</span>
<span class="go"> |-- s2!!: integer (nullable = false)</span>
<span class="go"> |-- s3!!.a: integer (nullable = false)</span>
<span class="go"> |-- s4!.a!: integer (nullable = false)</span>
<span class="go"> |-- s5!.a!.b.c: integer (nullable = false)</span>
</code></pre></div>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform_all_field_names</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nested</span><span class="o">.</span><span class="n">print_schema</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>
<span class="go">root</span>
<span class="go"> |-- NAME: string (nullable = false)</span>
<span class="go"> |-- S1!.A: integer (nullable = false)</span>
<span class="go"> |-- S2!!: integer (nullable = false)</span>
<span class="go"> |-- S3!!.A: integer (nullable = false)</span>
<span class="go"> |-- S4!.A!: integer (nullable = false)</span>
<span class="go"> |-- S5!.A!.B.C: integer (nullable = false)</span>
</code></pre></div>
    <p><em><strong>Example 2: sanitizing field names</strong></em></p>
<p>In this example we replace all dots and exclamation marks in field names with underscores.
This is useful to make a DataFrame compatible with the <a href="/reference/nested">spark_frame.nested</a>
module.</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT</span>
<span class="gp">... </span><span class="s1">    ARRAY(STRUCT(</span>
<span class="gp">... </span><span class="s1">        ARRAY(STRUCT(</span>
<span class="gp">... </span><span class="s1">            STRUCT(1 as `d.d!d`) as `c.c!c`</span>
<span class="gp">... </span><span class="s1">        )) as `b.b!b`</span>
<span class="gp">... </span><span class="s1">   )) as `a.a!a`</span>
<span class="gp">... </span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- a.a!a: array (nullable = false)</span>
<span class="go"> |    |-- element: struct (containsNull = false)</span>
<span class="go"> |    |    |-- b.b!b: array (nullable = false)</span>
<span class="go"> |    |    |    |-- element: struct (containsNull = false)</span>
<span class="go"> |    |    |    |    |-- c.c!c: struct (nullable = false)</span>
<span class="go"> |    |    |    |    |    |-- d.d!d: integer (nullable = false)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform_all_field_names</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- a_a_a: array (nullable = false)</span>
<span class="go"> |    |-- element: struct (containsNull = false)</span>
<span class="go"> |    |    |-- b_b_b: array (nullable = false)</span>
<span class="go"> |    |    |    |-- element: struct (containsNull = false)</span>
<span class="go"> |    |    |    |    |-- c_c_c: struct (nullable = false)</span>
<span class="go"> |    |    |    |    |    |-- d_d_d: integer (nullable = false)</span>
</code></pre></div>
    <p>This also works on fields of type <code>MAP&lt;K,V&gt;</code>.</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT MAP(STRUCT(1 as `a.a!a`), STRUCT(2 as `b.b!b`)) as `m.m!m`&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- m.m!m: map (nullable = false)</span>
<span class="go"> |    |-- key: struct</span>
<span class="go"> |    |    |-- a.a!a: integer (nullable = false)</span>
<span class="go"> |    |-- value: struct (valueContainsNull = false)</span>
<span class="go"> |    |    |-- b.b!b: integer (nullable = false)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform_all_field_names</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- m_m_m: map (nullable = false)</span>
<span class="go"> |    |-- key: struct</span>
<span class="go"> |    |    |-- a_a_a: integer (nullable = false)</span>
<span class="go"> |    |-- value: struct (valueContainsNull = false)</span>
<span class="go"> |    |    |-- b_b_b: integer (nullable = false)</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/transform_all_field_names.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">transform_all_field_names</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">transformation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Apply a transformation to all nested field names of a DataFrame.</span>

<span class="sd">    !!! info</span>
<span class="sd">        This method is compatible with any schema. It recursively applies on structs, arrays and maps</span>
<span class="sd">        and is compatible with field names containing special characters.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A Spark DataFrame</span>
<span class="sd">        transformation: Transformation to apply to all field names in the DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame</span>

<span class="sd">    Examples:</span>
<span class="sd">        _**Example 1: with a nested schema structure**_</span>

<span class="sd">        In this example we cast all the field names of the schema to uppercase:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; from spark_frame import nested</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;&#39;&#39;SELECT</span>
<span class="sd">        ...     &quot;John&quot; as name,</span>
<span class="sd">        ...     ARRAY(STRUCT(1 as a), STRUCT(2 as a)) as s1,</span>
<span class="sd">        ...     ARRAY(ARRAY(1, 2), ARRAY(3, 4)) as s2,</span>
<span class="sd">        ...     ARRAY(ARRAY(STRUCT(1 as a)), ARRAY(STRUCT(2 as a))) as s3,</span>
<span class="sd">        ...     ARRAY(STRUCT(ARRAY(1, 2) as a), STRUCT(ARRAY(3, 4) as a)) as s4,</span>
<span class="sd">        ...     ARRAY(</span>
<span class="sd">        ...         STRUCT(ARRAY(STRUCT(STRUCT(1 as c) as b), STRUCT(STRUCT(2 as c) as b)) as a),</span>
<span class="sd">        ...         STRUCT(ARRAY(STRUCT(STRUCT(3 as c) as b), STRUCT(STRUCT(4 as c) as b)) as a)</span>
<span class="sd">        ...     ) as s5</span>
<span class="sd">        ... &#39;&#39;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nested.print_schema(df)</span>
<span class="sd">        root</span>
<span class="sd">         |-- name: string (nullable = false)</span>
<span class="sd">         |-- s1!.a: integer (nullable = false)</span>
<span class="sd">         |-- s2!!: integer (nullable = false)</span>
<span class="sd">         |-- s3!!.a: integer (nullable = false)</span>
<span class="sd">         |-- s4!.a!: integer (nullable = false)</span>
<span class="sd">         |-- s5!.a!.b.c: integer (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        &gt;&gt;&gt; new_df = df.transform(transform_all_field_names, lambda s: s.upper())</span>
<span class="sd">        &gt;&gt;&gt; nested.print_schema(new_df)</span>
<span class="sd">        root</span>
<span class="sd">         |-- NAME: string (nullable = false)</span>
<span class="sd">         |-- S1!.A: integer (nullable = false)</span>
<span class="sd">         |-- S2!!: integer (nullable = false)</span>
<span class="sd">         |-- S3!!.A: integer (nullable = false)</span>
<span class="sd">         |-- S4!.A!: integer (nullable = false)</span>
<span class="sd">         |-- S5!.A!.B.C: integer (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        _**Example 2: sanitizing field names**_</span>

<span class="sd">        In this example we replace all dots and exclamation marks in field names with underscores.</span>
<span class="sd">        This is useful to make a DataFrame compatible with the [spark_frame.nested](/reference/nested)</span>
<span class="sd">        module.</span>
<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;&#39;&#39;SELECT</span>
<span class="sd">        ...     ARRAY(STRUCT(</span>
<span class="sd">        ...         ARRAY(STRUCT(</span>
<span class="sd">        ...             STRUCT(1 as `d.d!d`) as `c.c!c`</span>
<span class="sd">        ...         )) as `b.b!b`</span>
<span class="sd">        ...    )) as `a.a!a`</span>
<span class="sd">        ... &#39;&#39;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- a.a!a: array (nullable = false)</span>
<span class="sd">         |    |-- element: struct (containsNull = false)</span>
<span class="sd">         |    |    |-- b.b!b: array (nullable = false)</span>
<span class="sd">         |    |    |    |-- element: struct (containsNull = false)</span>
<span class="sd">         |    |    |    |    |-- c.c!c: struct (nullable = false)</span>
<span class="sd">         |    |    |    |    |    |-- d.d!d: integer (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; new_df = df.transform(transform_all_field_names, lambda s: s.replace(&quot;.&quot;,&quot;_&quot;).replace(&quot;!&quot;, &quot;_&quot;))</span>
<span class="sd">        &gt;&gt;&gt; new_df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- a_a_a: array (nullable = false)</span>
<span class="sd">         |    |-- element: struct (containsNull = false)</span>
<span class="sd">         |    |    |-- b_b_b: array (nullable = false)</span>
<span class="sd">         |    |    |    |-- element: struct (containsNull = false)</span>
<span class="sd">         |    |    |    |    |-- c_c_c: struct (nullable = false)</span>
<span class="sd">         |    |    |    |    |    |-- d_d_d: integer (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        This also works on fields of type `MAP&lt;K,V&gt;`.</span>
<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;SELECT MAP(STRUCT(1 as `a.a!a`), STRUCT(2 as `b.b!b`)) as `m.m!m`&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- m.m!m: map (nullable = false)</span>
<span class="sd">         |    |-- key: struct</span>
<span class="sd">         |    |    |-- a.a!a: integer (nullable = false)</span>
<span class="sd">         |    |-- value: struct (valueContainsNull = false)</span>
<span class="sd">         |    |    |-- b.b!b: integer (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; new_df = df.transform(transform_all_field_names, lambda s: s.replace(&quot;.&quot;,&quot;_&quot;).replace(&quot;!&quot;, &quot;_&quot;))</span>
<span class="sd">        &gt;&gt;&gt; new_df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- m_m_m: map (nullable = false)</span>
<span class="sd">         |    |-- key: struct</span>
<span class="sd">         |    |    |-- a_a_a: integer (nullable = false)</span>
<span class="sd">         |    |-- value: struct (valueContainsNull = false)</span>
<span class="sd">         |    |    |-- b_b_b: integer (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_transformation</span> <span class="o">=</span> <span class="n">build_transformation_from_schema</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">name_transformation</span><span class="o">=</span><span class="n">transformation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">root_transformation</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.transform_all_fields.transform_all_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">transform_all_fields</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">transformation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Column</span><span class="p">,</span> <span class="n">DataType</span><span class="p">],</span> <span class="n">Column</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Apply a transformation to all nested fields of a DataFrame.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This method is compatible with any schema. It recursively applies on structs, arrays and maps
and is compatible with field names containing special characters.</p>
</div>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>transformation</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-external" title="pyspark.sql.Column" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.Column.html#pyspark.sql.Column">Column</a>, <a class="autorefs autorefs-external" title="pyspark.sql.types.DataType" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.DataType.html#pyspark.sql.types.DataType">DataType</a>], <a class="autorefs autorefs-external" title="pyspark.sql.Column" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.Column.html#pyspark.sql.Column">Column</a>]</code>
          </td>
          <td><p>Transformation to apply to all fields of the DataFrame. The transformation must take as input
a Column expression and the DataType of the corresponding expression.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A new DataFrame</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">spark_frame</span> <span class="kn">import</span> <span class="n">nested</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT</span>
<span class="gp">... </span><span class="s1">    &quot;John&quot; as name,</span>
<span class="gp">... </span><span class="s1">    ARRAY(STRUCT(1 as a), STRUCT(2 as a)) as s1,</span>
<span class="gp">... </span><span class="s1">    ARRAY(ARRAY(1, 2), ARRAY(3, 4)) as s2,</span>
<span class="gp">... </span><span class="s1">    ARRAY(ARRAY(STRUCT(1 as a)), ARRAY(STRUCT(2 as a))) as s3,</span>
<span class="gp">... </span><span class="s1">    ARRAY(STRUCT(ARRAY(1, 2) as a), STRUCT(ARRAY(3, 4) as a)) as s4,</span>
<span class="gp">... </span><span class="s1">    ARRAY(</span>
<span class="gp">... </span><span class="s1">        STRUCT(ARRAY(STRUCT(STRUCT(1 as c) as b), STRUCT(STRUCT(2 as c) as b)) as a),</span>
<span class="gp">... </span><span class="s1">        STRUCT(ARRAY(STRUCT(STRUCT(3 as c) as b), STRUCT(STRUCT(4 as c) as b)) as a)</span>
<span class="gp">... </span><span class="s1">    ) as s5</span>
<span class="gp">... </span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nested</span><span class="o">.</span><span class="n">print_schema</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="go">root</span>
<span class="go"> |-- name: string (nullable = false)</span>
<span class="go"> |-- s1!.a: integer (nullable = false)</span>
<span class="go"> |-- s2!!: integer (nullable = false)</span>
<span class="go"> |-- s3!!.a: integer (nullable = false)</span>
<span class="go"> |-- s4!.a!: integer (nullable = false)</span>
<span class="go"> |-- s5!.a!.b.c: integer (nullable = false)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+----+----------+----------------+--------------+--------------------+------------------------------------+</span>
<span class="go">|name|s1        |s2              |s3            |s4                  |s5                                  |</span>
<span class="go">+----+----------+----------------+--------------+--------------------+------------------------------------+</span>
<span class="go">|John|[{1}, {2}]|[[1, 2], [3, 4]]|[[{1}], [{2}]]|[{[1, 2]}, {[3, 4]}]|[{[{{1}}, {{2}}]}, {[{{3}}, {{4}}]}]|</span>
<span class="go">+----+----------+----------------+--------------+--------------------+------------------------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">IntegerType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">cast_int_as_double</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="n">Column</span><span class="p">,</span> <span class="n">data_type</span><span class="p">:</span> <span class="n">DataType</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">col</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;DOUBLE&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform_all_fields</span><span class="p">,</span> <span class="n">cast_int_as_double</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nested</span><span class="o">.</span><span class="n">print_schema</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>
<span class="go">root</span>
<span class="go"> |-- name: string (nullable = false)</span>
<span class="go"> |-- s1!.a: double (nullable = false)</span>
<span class="go"> |-- s2!!: double (nullable = false)</span>
<span class="go"> |-- s3!!.a: double (nullable = false)</span>
<span class="go"> |-- s4!.a!: double (nullable = false)</span>
<span class="go"> |-- s5!.a!.b.c: double (nullable = false)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">new_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
<span class="go">+----+--------------+------------------------+------------------+----------------------------+--------------------------------------------+</span>
<span class="go">|name|s1            |s2                      |s3                |s4                          |s5                                          |</span>
<span class="go">+----+--------------+------------------------+------------------+----------------------------+--------------------------------------------+</span>
<span class="go">|John|[{1.0}, {2.0}]|[[1.0, 2.0], [3.0, 4.0]]|[[{1.0}], [{2.0}]]|[{[1.0, 2.0]}, {[3.0, 4.0]}]|[{[{{1.0}}, {{2.0}}]}, {[{{3.0}}, {{4.0}}]}]|</span>
<span class="go">+----+--------------+------------------------+------------------+----------------------------+--------------------------------------------+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/transform_all_fields.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">transform_all_fields</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">transformation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Column</span><span class="p">,</span> <span class="n">DataType</span><span class="p">],</span> <span class="n">Column</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Apply a transformation to all nested fields of a DataFrame.</span>

<span class="sd">    !!! info</span>
<span class="sd">        This method is compatible with any schema. It recursively applies on structs, arrays and maps</span>
<span class="sd">        and is compatible with field names containing special characters.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A Spark DataFrame</span>
<span class="sd">        transformation: Transformation to apply to all fields of the DataFrame. The transformation must take as input</span>
<span class="sd">            a Column expression and the DataType of the corresponding expression.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; from spark_frame import nested</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.sql(&#39;&#39;&#39;SELECT</span>
<span class="sd">        ...     &quot;John&quot; as name,</span>
<span class="sd">        ...     ARRAY(STRUCT(1 as a), STRUCT(2 as a)) as s1,</span>
<span class="sd">        ...     ARRAY(ARRAY(1, 2), ARRAY(3, 4)) as s2,</span>
<span class="sd">        ...     ARRAY(ARRAY(STRUCT(1 as a)), ARRAY(STRUCT(2 as a))) as s3,</span>
<span class="sd">        ...     ARRAY(STRUCT(ARRAY(1, 2) as a), STRUCT(ARRAY(3, 4) as a)) as s4,</span>
<span class="sd">        ...     ARRAY(</span>
<span class="sd">        ...         STRUCT(ARRAY(STRUCT(STRUCT(1 as c) as b), STRUCT(STRUCT(2 as c) as b)) as a),</span>
<span class="sd">        ...         STRUCT(ARRAY(STRUCT(STRUCT(3 as c) as b), STRUCT(STRUCT(4 as c) as b)) as a)</span>
<span class="sd">        ...     ) as s5</span>
<span class="sd">        ... &#39;&#39;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nested.print_schema(df)</span>
<span class="sd">        root</span>
<span class="sd">         |-- name: string (nullable = false)</span>
<span class="sd">         |-- s1!.a: integer (nullable = false)</span>
<span class="sd">         |-- s2!!: integer (nullable = false)</span>
<span class="sd">         |-- s3!!.a: integer (nullable = false)</span>
<span class="sd">         |-- s4!.a!: integer (nullable = false)</span>
<span class="sd">         |-- s5!.a!.b.c: integer (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df.show(truncate=False)</span>
<span class="sd">        +----+----------+----------------+--------------+--------------------+------------------------------------+</span>
<span class="sd">        |name|s1        |s2              |s3            |s4                  |s5                                  |</span>
<span class="sd">        +----+----------+----------------+--------------+--------------------+------------------------------------+</span>
<span class="sd">        |John|[{1}, {2}]|[[1, 2], [3, 4]]|[[{1}], [{2}]]|[{[1, 2]}, {[3, 4]}]|[{[{{1}}, {{2}}]}, {[{{3}}, {{4}}]}]|</span>
<span class="sd">        +----+----------+----------------+--------------+--------------------+------------------------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql.types import IntegerType</span>
<span class="sd">        &gt;&gt;&gt; def cast_int_as_double(col: Column, data_type: DataType):</span>
<span class="sd">        ...     if isinstance(data_type, IntegerType):</span>
<span class="sd">        ...         return col.cast(&quot;DOUBLE&quot;)</span>
<span class="sd">        &gt;&gt;&gt; new_df = df.transform(transform_all_fields, cast_int_as_double)</span>
<span class="sd">        &gt;&gt;&gt; nested.print_schema(new_df)</span>
<span class="sd">        root</span>
<span class="sd">         |-- name: string (nullable = false)</span>
<span class="sd">         |-- s1!.a: double (nullable = false)</span>
<span class="sd">         |-- s2!!: double (nullable = false)</span>
<span class="sd">         |-- s3!!.a: double (nullable = false)</span>
<span class="sd">         |-- s4!.a!: double (nullable = false)</span>
<span class="sd">         |-- s5!.a!.b.c: double (nullable = false)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; new_df.show(truncate=False)  # noqa: E501</span>
<span class="sd">        +----+--------------+------------------------+------------------+----------------------------+--------------------------------------------+</span>
<span class="sd">        |name|s1            |s2                      |s3                |s4                          |s5                                          |</span>
<span class="sd">        +----+--------------+------------------------+------------------+----------------------------+--------------------------------------------+</span>
<span class="sd">        |John|[{1.0}, {2.0}]|[[1.0, 2.0], [3.0, 4.0]]|[[{1.0}], [{2.0}]]|[{[1.0, 2.0]}, {[3.0, 4.0]}]|[{[{{1.0}}, {{2.0}}]}, {[{{3.0}}, {{4.0}}]}]|</span>
<span class="sd">        +----+--------------+------------------------+------------------+----------------------------+--------------------------------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_transformation</span> <span class="o">=</span> <span class="n">build_transformation_from_schema</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">column_transformation</span><span class="o">=</span><span class="n">transformation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">root_transformation</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.unflatten.unflatten" class="doc doc-heading">
<code class="highlight language-python"><span class="n">unflatten</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Reverse of the flatten operation
Nested fields names will be separated from each other using the specified separator</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Spark DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>separator</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>A string used to separate the structs names from their elements.
       It might be useful to change the separator when some DataFrame's column names already contain dots</p></td>
          <td>
                <code>&#39;.&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A flattened DataFrame</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="s2">&quot;id INT, `s.a` INT, `s.b.c` INT, `s.b.d` INT&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s.a: integer (nullable = true)</span>
<span class="go"> |-- s.b.c: integer (nullable = true)</span>
<span class="go"> |-- s.b.d: integer (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">unflatten</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s: struct (nullable = true)</span>
<span class="go"> |    |-- a: integer (nullable = true)</span>
<span class="go"> |    |-- b: struct (nullable = true)</span>
<span class="go"> |    |    |-- c: integer (nullable = true)</span>
<span class="go"> |    |    |-- d: integer (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="s2">&quot;id INT, `s.s1?a.a1` INT, `s.s1?b.b1` INT&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s.s1?a.a1: integer (nullable = true)</span>
<span class="go"> |-- s.s1?b.b1: integer (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">unflatten</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- s.s1: struct (nullable = true)</span>
<span class="go"> |    |-- a.a1: integer (nullable = true)</span>
<span class="go"> |    |-- b.b1: integer (nullable = true)</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/unflatten.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">unflatten</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Reverse of the flatten operation</span>
<span class="sd">    Nested fields names will be separated from each other using the specified separator</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A Spark DataFrame</span>
<span class="sd">        separator: A string used to separate the structs names from their elements.</span>
<span class="sd">                   It might be useful to change the separator when some DataFrame&#39;s column names already contain dots</span>

<span class="sd">    Returns:</span>
<span class="sd">        A flattened DataFrame</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame([(1, 1, 1, 1)], &quot;id INT, `s.a` INT, `s.b.c` INT, `s.b.d` INT&quot;)</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s.a: integer (nullable = true)</span>
<span class="sd">         |-- s.b.c: integer (nullable = true)</span>
<span class="sd">         |-- s.b.d: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; unflatten(df).printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s: struct (nullable = true)</span>
<span class="sd">         |    |-- a: integer (nullable = true)</span>
<span class="sd">         |    |-- b: struct (nullable = true)</span>
<span class="sd">         |    |    |-- c: integer (nullable = true)</span>
<span class="sd">         |    |    |-- d: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame([(1, 1, 1)], &quot;id INT, `s.s1?a.a1` INT, `s.s1?b.b1` INT&quot;)</span>
<span class="sd">        &gt;&gt;&gt; df.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s.s1?a.a1: integer (nullable = true)</span>
<span class="sd">         |-- s.s1?b.b1: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; unflatten(df, &quot;?&quot;).printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- s.s1: struct (nullable = true)</span>
<span class="sd">         |    |-- a.a1: integer (nullable = true)</span>
<span class="sd">         |    |-- b.b1: integer (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The idea is to recursively write a &quot;SELECT struct(a, struct(s.b.c, s.b.d)) as s&quot; for each nested column.</span>
    <span class="c1"># There is a little twist as we don&#39;t want to rebuild the struct if all its fields are null, so we add a CASE WHEN</span>

    <span class="k">def</span> <span class="nf">has_structs</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">struct_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span> <span class="k">if</span> <span class="n">is_struct</span><span class="p">(</span><span class="n">field</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct_fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">has_structs</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">_build_nested_struct_tree</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">_build_struct_from_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.union_dataframes.union_dataframes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">union_dataframes</span><span class="p">(</span><span class="o">*</span><span class="n">dfs</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Returns the union between multiple DataFrames</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dfs</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>One or more Spark DataFrames</p></td>
          <td>
                <code>()</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A new DataFrame containing the union of all input DataFrames</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT 1 as a&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df2</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT 2 as a&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df3</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;SELECT 3 as a&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">union_dataframes</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+</span>
<span class="go">|  a|</span>
<span class="go">+---+</span>
<span class="go">|  1|</span>
<span class="go">|  2|</span>
<span class="go">|  3|</span>
<span class="go">+---+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">df1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">union_dataframes</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+---+</span>
<span class="go">|  a|</span>
<span class="go">+---+</span>
<span class="go">|  1|</span>
<span class="go">|  2|</span>
<span class="go">|  3|</span>
<span class="go">+---+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/union_dataframes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">union_dataframes</span><span class="p">(</span><span class="o">*</span><span class="n">dfs</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns the union between multiple DataFrames</span>

<span class="sd">    Args:</span>
<span class="sd">        dfs: One or more Spark DataFrames</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame containing the union of all input DataFrames</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df1 = spark.sql(&#39;SELECT 1 as a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df2 = spark.sql(&#39;SELECT 2 as a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df3 = spark.sql(&#39;SELECT 3 as a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; union_dataframes(df1, df2, df3).show()</span>
<span class="sd">        +---+</span>
<span class="sd">        |  a|</span>
<span class="sd">        +---+</span>
<span class="sd">        |  1|</span>
<span class="sd">        |  2|</span>
<span class="sd">        |  3|</span>
<span class="sd">        +---+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; df1.transform(union_dataframes, df2, df3).show()</span>
<span class="sd">        +---+</span>
<span class="sd">        |  a|</span>
<span class="sd">        +---+</span>
<span class="sd">        |  1|</span>
<span class="sd">        |  2|</span>
<span class="sd">        |  3|</span>
<span class="sd">        +---+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">assert_true</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input list is empty&quot;</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.unpivot.unpivot" class="doc doc-heading">
<code class="highlight language-python"><span class="n">unpivot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">pivot_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">key_alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">value_alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Unpivot the given DataFrame along the specified pivot columns.
All columns that are not pivot columns should have the same type.</p>
<p>This is the inverse transformation of the <a class="autorefs autorefs-external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.GroupedData.pivot.html#pyspark.sql.GroupedData.pivot">pyspark.sql.GroupedData.pivot</a> operation.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A DataFrame</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>pivot_columns</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>The list of columns names on which to perform the pivot</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>key_alias</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Alias given to the 'key' column</p></td>
          <td>
                <code>&#39;key&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>value_alias</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Alias given to the 'value' column</p></td>
          <td>
                <code>&#39;value&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>An unpivotted DataFrame</p></td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="s2">&quot;Orange&quot;</span><span class="p">,</span>  <span class="kc">None</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="s2">&quot;Beans&quot;</span><span class="p">,</span>   <span class="kc">None</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="s2">&quot;Banana&quot;</span><span class="p">,</span>  <span class="mi">2000</span><span class="p">,</span>  <span class="mi">400</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="s2">&quot;Carrots&quot;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="s2">&quot;Orange&quot;</span><span class="p">,</span>  <span class="mi">5000</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="s2">&quot;Beans&quot;</span><span class="p">,</span>   <span class="kc">None</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="s2">&quot;Banana&quot;</span><span class="p">,</span>  <span class="kc">None</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span>  <span class="mi">400</span><span class="p">),</span>
<span class="gp">... </span>   <span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="s2">&quot;Carrots&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>  <span class="mi">200</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="gp">... </span> <span class="p">],</span> <span class="s2">&quot;year INT, product STRING, Canada INT, China INT, Mexico INT&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">+----+-------+------+-----+------+</span>
<span class="go">|year|product|Canada|China|Mexico|</span>
<span class="go">+----+-------+------+-----+------+</span>
<span class="go">|2018| Orange|  null| 4000|  null|</span>
<span class="go">|2018|  Beans|  null| 1500|  2000|</span>
<span class="go">|2018| Banana|  2000|  400|  null|</span>
<span class="go">|2018|Carrots|  2000| 1200|  null|</span>
<span class="go">|2019| Orange|  5000| null|  5000|</span>
<span class="go">|2019|  Beans|  null| 1500|  2000|</span>
<span class="go">|2019| Banana|  null| 1400|   400|</span>
<span class="go">|2019|Carrots|  null|  200|  null|</span>
<span class="go">+----+-------+------+-----+------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">unpivot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">],</span> <span class="n">key_alias</span><span class="o">=</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="n">value_alias</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="go">+----+-------+-------+-----+</span>
<span class="go">|year|product|country|total|</span>
<span class="go">+----+-------+-------+-----+</span>
<span class="go">|2018| Orange| Canada| null|</span>
<span class="go">|2018| Orange|  China| 4000|</span>
<span class="go">|2018| Orange| Mexico| null|</span>
<span class="go">|2018|  Beans| Canada| null|</span>
<span class="go">|2018|  Beans|  China| 1500|</span>
<span class="go">|2018|  Beans| Mexico| 2000|</span>
<span class="go">|2018| Banana| Canada| 2000|</span>
<span class="go">|2018| Banana|  China|  400|</span>
<span class="go">|2018| Banana| Mexico| null|</span>
<span class="go">|2018|Carrots| Canada| 2000|</span>
<span class="go">|2018|Carrots|  China| 1200|</span>
<span class="go">|2018|Carrots| Mexico| null|</span>
<span class="go">|2019| Orange| Canada| 5000|</span>
<span class="go">|2019| Orange|  China| null|</span>
<span class="go">|2019| Orange| Mexico| 5000|</span>
<span class="go">|2019|  Beans| Canada| null|</span>
<span class="go">|2019|  Beans|  China| 1500|</span>
<span class="go">|2019|  Beans| Mexico| 2000|</span>
<span class="go">|2019| Banana| Canada| null|</span>
<span class="go">|2019| Banana|  China| 1400|</span>
<span class="go">|2019| Banana| Mexico|  400|</span>
<span class="go">|2019|Carrots| Canada| null|</span>
<span class="go">|2019|Carrots|  China|  200|</span>
<span class="go">|2019|Carrots| Mexico| null|</span>
<span class="go">+----+-------+-------+-----+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/unpivot.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">unpivot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">pivot_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">key_alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">value_alias</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Unpivot the given DataFrame along the specified pivot columns.</span>
<span class="sd">    All columns that are not pivot columns should have the same type.</span>

<span class="sd">    This is the inverse transformation of the [pyspark.sql.GroupedData.pivot][] operation.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A DataFrame</span>
<span class="sd">        pivot_columns: The list of columns names on which to perform the pivot</span>
<span class="sd">        key_alias: Alias given to the &#39;key&#39; column</span>
<span class="sd">        value_alias: Alias given to the &#39;value&#39; column</span>

<span class="sd">    Returns:</span>
<span class="sd">        An unpivotted DataFrame</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame([</span>
<span class="sd">        ...    (2018, &quot;Orange&quot;,  None, 4000, None),</span>
<span class="sd">        ...    (2018, &quot;Beans&quot;,   None, 1500, 2000),</span>
<span class="sd">        ...    (2018, &quot;Banana&quot;,  2000,  400, None),</span>
<span class="sd">        ...    (2018, &quot;Carrots&quot;, 2000, 1200, None),</span>
<span class="sd">        ...    (2019, &quot;Orange&quot;,  5000, None, 5000),</span>
<span class="sd">        ...    (2019, &quot;Beans&quot;,   None, 1500, 2000),</span>
<span class="sd">        ...    (2019, &quot;Banana&quot;,  None, 1400,  400),</span>
<span class="sd">        ...    (2019, &quot;Carrots&quot;, None,  200, None),</span>
<span class="sd">        ...  ], &quot;year INT, product STRING, Canada INT, China INT, Mexico INT&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; df.show()</span>
<span class="sd">        +----+-------+------+-----+------+</span>
<span class="sd">        |year|product|Canada|China|Mexico|</span>
<span class="sd">        +----+-------+------+-----+------+</span>
<span class="sd">        |2018| Orange|  null| 4000|  null|</span>
<span class="sd">        |2018|  Beans|  null| 1500|  2000|</span>
<span class="sd">        |2018| Banana|  2000|  400|  null|</span>
<span class="sd">        |2018|Carrots|  2000| 1200|  null|</span>
<span class="sd">        |2019| Orange|  5000| null|  5000|</span>
<span class="sd">        |2019|  Beans|  null| 1500|  2000|</span>
<span class="sd">        |2019| Banana|  null| 1400|   400|</span>
<span class="sd">        |2019|Carrots|  null|  200|  null|</span>
<span class="sd">        +----+-------+------+-----+------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; unpivot(df, [&#39;year&#39;, &#39;product&#39;], key_alias=&#39;country&#39;, value_alias=&#39;total&#39;).show(100)</span>
<span class="sd">        +----+-------+-------+-----+</span>
<span class="sd">        |year|product|country|total|</span>
<span class="sd">        +----+-------+-------+-----+</span>
<span class="sd">        |2018| Orange| Canada| null|</span>
<span class="sd">        |2018| Orange|  China| 4000|</span>
<span class="sd">        |2018| Orange| Mexico| null|</span>
<span class="sd">        |2018|  Beans| Canada| null|</span>
<span class="sd">        |2018|  Beans|  China| 1500|</span>
<span class="sd">        |2018|  Beans| Mexico| 2000|</span>
<span class="sd">        |2018| Banana| Canada| 2000|</span>
<span class="sd">        |2018| Banana|  China|  400|</span>
<span class="sd">        |2018| Banana| Mexico| null|</span>
<span class="sd">        |2018|Carrots| Canada| 2000|</span>
<span class="sd">        |2018|Carrots|  China| 1200|</span>
<span class="sd">        |2018|Carrots| Mexico| null|</span>
<span class="sd">        |2019| Orange| Canada| 5000|</span>
<span class="sd">        |2019| Orange|  China| null|</span>
<span class="sd">        |2019| Orange| Mexico| 5000|</span>
<span class="sd">        |2019|  Beans| Canada| null|</span>
<span class="sd">        |2019|  Beans|  China| 1500|</span>
<span class="sd">        |2019|  Beans| Mexico| 2000|</span>
<span class="sd">        |2019| Banana| Canada| null|</span>
<span class="sd">        |2019| Banana|  China| 1400|</span>
<span class="sd">        |2019| Banana| Mexico|  400|</span>
<span class="sd">        |2019|Carrots| Canada| null|</span>
<span class="sd">        |2019|Carrots|  China|  200|</span>
<span class="sd">        |2019|Carrots| Mexico| null|</span>
<span class="sd">        +----+-------+-------+-----+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pivoted_columns</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pivot_columns</span><span class="p">]</span>
    <span class="n">cols</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pivoted_columns</span><span class="p">)</span>

    <span class="c1"># Check that all columns have the same type.</span>
    <span class="n">assert_true</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">types</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;All pivoted columns should be of the same type:</span><span class="se">\n</span><span class="s2"> Pivoted columns are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pivoted_columns</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Create and explode an array of (column_name, column_value) structs</span>
    <span class="n">kvs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span>
        <span class="n">f</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">key_alias</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">value_alias</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span>
    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;kvs&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">quote_columns</span><span class="p">(</span><span class="n">pivot_columns</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">kvs</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">quote_columns</span><span class="p">(</span><span class="n">pivot_columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;kvs.*&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />


<div class="doc doc-object doc-function">



<h3 id="spark_frame.transformations_impl.with_generic_typed_struct.with_generic_typed_struct" class="doc doc-heading">
<code class="highlight language-python"><span class="n">with_generic_typed_struct</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">col_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span></code>

</h3>


  <div class="doc doc-contents first">
  
      <p>Transform the specified struct columns of a given <a class="autorefs autorefs-external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">Dataframe</a> into
generic typed struct columns with the following generic schema
(based on <a href="https://spark.apache.org/docs/latest/sql-ref-datatypes.html">https://spark.apache.org/docs/latest/sql-ref-datatypes.html</a>) :</p>
<pre><code>STRUCT&lt;
    key: STRING, -- (name of the field inside the struct)
    type: STRING, -- (type of the field inside the struct)
    value: STRUCT&lt; -- (all the fields will be null except for the one with the correct type)
        date: DATE,
        timestamp: TIMESTAMP,
        int: LONG,
        float: DOUBLE,
        boolean: BOOLEAN,
        string: STRING,
        bytes: BINARY
    &gt;
&gt;
</code></pre>
<p>The following spark types will be automatically cast into the more generic following types:</p>
<ul>
<li><code>tinyint</code>, <code>smallint</code>, <code>int</code> -&gt; <code>bigint</code></li>
<li><code>float</code>, <code>decimal</code> -&gt; <code>double</code></li>
</ul>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>The Dataframe to transform</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>col_names</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>A list of column names to transform</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-external" title="pyspark.sql.DataFrame" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html#pyspark.sql.DataFrame">DataFrame</a></code>
          </td>
          <td><p>A Dataframe with the columns transformed into generic typed structs</p></td>
        </tr>
    </tbody>
  </table>
      <div class="admonition warning">
<p class="admonition-title">Limitations</p>
<p>Currently, complex field types (structs, maps, arrays) are not supported.
All fields of the struct columns to convert must be of basic types.</p>
</div>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;doctest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;first.name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jacques&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;is.an.adult&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span>
<span class="gp">... </span>     <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;first.name&quot;</span><span class="p">:</span> <span class="s2">&quot;Michel&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;is.an.adult&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}),</span>
<span class="gp">... </span>     <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;first.name&quot;</span><span class="p">:</span> <span class="s2">&quot;Marie&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s2">&quot;is.an.adult&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})],</span>
<span class="gp">... </span>    <span class="s2">&quot;id INT, `person.struct` STRUCT&lt;`first.name`:STRING, age:INT, `is.an.adult`:BOOLEAN&gt;&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">+---+-------------------+</span>
<span class="go">|id |person.struct      |</span>
<span class="go">+---+-------------------+</span>
<span class="go">|1  |{Jacques, 25, true}|</span>
<span class="go">|2  |{Michel, 12, false}|</span>
<span class="go">|3  |{Marie, 36, true}  |</span>
<span class="go">+---+-------------------+</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">with_generic_typed_struct</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;`person.struct`&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="go">root</span>
<span class="go"> |-- id: integer (nullable = true)</span>
<span class="go"> |-- person.struct: array (nullable = false)</span>
<span class="go"> |    |-- element: struct (containsNull = false)</span>
<span class="go"> |    |    |-- key: string (nullable = false)</span>
<span class="go"> |    |    |-- type: string (nullable = false)</span>
<span class="go"> |    |    |-- value: struct (nullable = false)</span>
<span class="go"> |    |    |    |-- boolean: boolean (nullable = true)</span>
<span class="go"> |    |    |    |-- bytes: binary (nullable = true)</span>
<span class="go"> |    |    |    |-- date: date (nullable = true)</span>
<span class="go"> |    |    |    |-- float: double (nullable = true)</span>
<span class="go"> |    |    |    |-- int: long (nullable = true)</span>
<span class="go"> |    |    |    |-- string: string (nullable = true)</span>
<span class="go"> |    |    |    |-- timestamp: timestamp (nullable = true)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># noqa: E501</span>
<span class="go">+---+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="go">|id |person.struct                                                                                                                                                                                  |</span>
<span class="go">+---+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="go">|1  |[{first.name, string, {null, null, null, null, null, Jacques, null}}, {age, int, {null, null, null, null, 25, null, null}}, {is.an.adult, boolean, {true, null, null, null, null, null, null}}]|</span>
<span class="go">|2  |[{first.name, string, {null, null, null, null, null, Michel, null}}, {age, int, {null, null, null, null, 12, null, null}}, {is.an.adult, boolean, {false, null, null, null, null, null, null}}]|</span>
<span class="go">|3  |[{first.name, string, {null, null, null, null, null, Marie, null}}, {age, int, {null, null, null, null, 36, null, null}}, {is.an.adult, boolean, {true, null, null, null, null, null, null}}]  |</span>
<span class="go">+---+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>spark_frame/transformations_impl/with_generic_typed_struct.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">with_generic_typed_struct</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">col_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Transform the specified struct columns of a given [Dataframe][pyspark.sql.DataFrame] into</span>
<span class="sd">    generic typed struct columns with the following generic schema</span>
<span class="sd">    (based on [https://spark.apache.org/docs/latest/sql-ref-datatypes.html](</span>
<span class="sd">    https://spark.apache.org/docs/latest/sql-ref-datatypes.html)) :</span>

<span class="sd">        STRUCT&lt;</span>
<span class="sd">            key: STRING, -- (name of the field inside the struct)</span>
<span class="sd">            type: STRING, -- (type of the field inside the struct)</span>
<span class="sd">            value: STRUCT&lt; -- (all the fields will be null except for the one with the correct type)</span>
<span class="sd">                date: DATE,</span>
<span class="sd">                timestamp: TIMESTAMP,</span>
<span class="sd">                int: LONG,</span>
<span class="sd">                float: DOUBLE,</span>
<span class="sd">                boolean: BOOLEAN,</span>
<span class="sd">                string: STRING,</span>
<span class="sd">                bytes: BINARY</span>
<span class="sd">            &gt;</span>
<span class="sd">        &gt;</span>

<span class="sd">    The following spark types will be automatically cast into the more generic following types:</span>

<span class="sd">    - `tinyint`, `smallint`, `int` -&gt; `bigint`</span>
<span class="sd">    - `float`, `decimal` -&gt; `double`</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The Dataframe to transform</span>
<span class="sd">        col_names: A list of column names to transform</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Dataframe with the columns transformed into generic typed structs</span>

<span class="sd">    !!! warning &quot;Limitations&quot;</span>
<span class="sd">        Currently, complex field types (structs, maps, arrays) are not supported.</span>
<span class="sd">        All fields of the struct columns to convert must be of basic types.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from pyspark.sql import SparkSession</span>
<span class="sd">        &gt;&gt;&gt; spark = SparkSession.builder.appName(&quot;doctest&quot;).getOrCreate()</span>
<span class="sd">        &gt;&gt;&gt; df = spark.createDataFrame(</span>
<span class="sd">        ...     [(1, {&quot;first.name&quot;: &quot;Jacques&quot;, &quot;age&quot;: 25, &quot;is.an.adult&quot;: True}),</span>
<span class="sd">        ...      (2, {&quot;first.name&quot;: &quot;Michel&quot;, &quot;age&quot;: 12, &quot;is.an.adult&quot;: False}),</span>
<span class="sd">        ...      (3, {&quot;first.name&quot;: &quot;Marie&quot;, &quot;age&quot;: 36, &quot;is.an.adult&quot;: True})],</span>
<span class="sd">        ...     &quot;id INT, `person.struct` STRUCT&lt;`first.name`:STRING, age:INT, `is.an.adult`:BOOLEAN&gt;&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; df.show(truncate=False)</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        |id |person.struct      |</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        |1  |{Jacques, 25, true}|</span>
<span class="sd">        |2  |{Michel, 12, false}|</span>
<span class="sd">        |3  |{Marie, 36, true}  |</span>
<span class="sd">        +---+-------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; res = with_generic_typed_struct(df, [&quot;`person.struct`&quot;])</span>
<span class="sd">        &gt;&gt;&gt; res.printSchema()</span>
<span class="sd">        root</span>
<span class="sd">         |-- id: integer (nullable = true)</span>
<span class="sd">         |-- person.struct: array (nullable = false)</span>
<span class="sd">         |    |-- element: struct (containsNull = false)</span>
<span class="sd">         |    |    |-- key: string (nullable = false)</span>
<span class="sd">         |    |    |-- type: string (nullable = false)</span>
<span class="sd">         |    |    |-- value: struct (nullable = false)</span>
<span class="sd">         |    |    |    |-- boolean: boolean (nullable = true)</span>
<span class="sd">         |    |    |    |-- bytes: binary (nullable = true)</span>
<span class="sd">         |    |    |    |-- date: date (nullable = true)</span>
<span class="sd">         |    |    |    |-- float: double (nullable = true)</span>
<span class="sd">         |    |    |    |-- int: long (nullable = true)</span>
<span class="sd">         |    |    |    |-- string: string (nullable = true)</span>
<span class="sd">         |    |    |    |-- timestamp: timestamp (nullable = true)</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        &gt;&gt;&gt; res.show(10, False) # noqa: E501</span>
<span class="sd">        +---+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">        |id |person.struct                                                                                                                                                                                  |</span>
<span class="sd">        +---+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">        |1  |[{first.name, string, {null, null, null, null, null, Jacques, null}}, {age, int, {null, null, null, null, 25, null, null}}, {is.an.adult, boolean, {true, null, null, null, null, null, null}}]|</span>
<span class="sd">        |2  |[{first.name, string, {null, null, null, null, null, Michel, null}}, {age, int, {null, null, null, null, 12, null, null}}, {is.an.adult, boolean, {false, null, null, null, null, null, null}}]|</span>
<span class="sd">        |3  |[{first.name, string, {null, null, null, null, null, Marie, null}}, {age, int, {null, null, null, null, 36, null, null}}, {is.an.adult, boolean, {true, null, null, null, null, null, null}}]  |</span>
<span class="sd">        +---+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">source_to_cast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tinyint&quot;</span><span class="p">:</span> <span class="s2">&quot;bigint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;smallint&quot;</span><span class="p">:</span> <span class="s2">&quot;bigint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="s2">&quot;bigint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bigint&quot;</span><span class="p">:</span> <span class="s2">&quot;bigint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="s2">&quot;double&quot;</span><span class="p">,</span>
        <span class="s2">&quot;double&quot;</span><span class="p">:</span> <span class="s2">&quot;double&quot;</span><span class="p">,</span>
        <span class="s2">&quot;boolean&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;Mapping indicating for each source Spark DataTypes the type into which it will be cast.&quot;&quot;&quot;</span>

    <span class="n">cast_to_name</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="s2">&quot;bytes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bigint&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
        <span class="s2">&quot;double&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;Mapping indicating for each already cast Spark DataTypes the name of the corresponding field.</span>
<span class="sd">    When missing, the same name will be kept.&quot;&quot;&quot;</span>

    <span class="n">name_cast</span> <span class="o">=</span> <span class="p">{</span><span class="n">cast_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">source_to_cast</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
    <span class="c1"># We make sure the types are sorted</span>
    <span class="n">name_cast</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">name_cast</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span>

    <span class="k">def</span> <span class="nf">match_regex_types</span><span class="p">(</span><span class="n">source_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Matches the source types against regexes to identify more complex types (like Decimal(x, y))&quot;&quot;&quot;</span>
        <span class="n">regex_to_cast_types</span> <span class="o">=</span> <span class="p">[(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;decimal(.*)&quot;</span><span class="p">),</span> <span class="s2">&quot;float&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">regex</span><span class="p">,</span> <span class="n">cast_type</span> <span class="ow">in</span> <span class="n">regex_to_cast_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast_type</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">field_to_col</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Column</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Transforms the specified field into a generic column&quot;&quot;&quot;</span>
        <span class="n">source_type</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">dataType</span><span class="o">.</span><span class="n">simpleString</span><span class="p">()</span>
        <span class="n">cast_type</span> <span class="o">=</span> <span class="n">source_to_cast</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">quote</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cast_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cast_type</span> <span class="o">=</span> <span class="n">match_regex_types</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cast_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: The field </span><span class="si">{field_name}</span><span class="s2"> is of type </span><span class="si">{source_type}</span><span class="s2"> which is currently unsupported. &quot;</span>
                <span class="s2">&quot;This field will be dropped.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="n">source_type</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">name_type</span> <span class="o">=</span> <span class="n">cast_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cast_type</span><span class="p">,</span> <span class="n">cast_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
            <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">),</span>
            <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">name_type</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
            <span class="c1"># In the code below, we use f.expr instead of f.col because it looks like f.col</span>
            <span class="c1"># does not support column names with backquotes in them, but f.expr does :-p</span>
            <span class="n">f</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name_type</span> <span class="o">==</span> <span class="n">name_t</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cast_t</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name_t</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name_t</span><span class="p">,</span> <span class="n">cast_t</span> <span class="ow">in</span> <span class="n">name_cast</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">_get_nested_col_type_from_schema</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">assert_true</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">StructType</span><span class="p">))</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">StructType</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_to_col</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">col_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
        <span class="n">columns_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="n">col_name</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">*</span><span class="n">columns_2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div><hr />





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../schema_utils/" class="md-footer__link md-footer__link--prev" aria-label="Previous: spark_frame.schema_utils" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              spark_frame.schema_utils
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>